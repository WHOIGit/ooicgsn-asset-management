# OOI (Endurance) Instrument Calibration File Parsers coded in Matlab

The following scripts extract calibration information from various manufacturer calibration sheets or from captured text files created during OSU QCTs (document numbers 3305-001XX-YYYYY where XX codes for the instrument class and YYYYY is the sequence number; the instrument's serial number is given in the Title property). The calibration coefficients are required to process raw data into data in engineering (scientific) units. 

These scripts automatically create 'csv' calibration files in the format requested by ooi-integration.

The scripts currently support csv calibration file creation for the following instrument classes written for Endurance deployments. Read the documentation in the scripts for the instrument series coverage; it is possible that the scripts can be used for instruments in other series if those instrument calibrations are compatible.

* CTDBP
* DOFST
* DOSTA
* FLORT
* NUTNR
* OPTAA
* PARAD
* PCO2W
* PHSEN
* PRESF
* SPKIR

## Getting Started

Obtain a computer which can run Matlab.

## Prerequisites

Install Matlab R2018b or later on a computer. Earlier versions may work (original functions were coded in September 2015) but several useful enhancements were introduced in R2016b ('contains' function, the "string" data type, etc) which may have made their way into some of the code.

## Running the code

The main routine (scripts which start with 'write_') and any subfunction it may call (a corresponding script which includes 'read' in its name if present) must be located in the Matlab path or working directory. To run a script make sure that the input file (a vendor calibration file or QCT file) is in the working directory. Call the main routine from either the Matlab command line or from a calling Matlab program; the newly created csv calibration file will be written into the working directory. 

These scripts were written for Endurance deployments so that the main routines may need to be slightly modified. For example some of the main scripts determine the instrument series (required to name the csv calibration file) from the vendor serial number and only Endurance serial numbers are hard-coded into these particular scripts. 

## Using the code to upload csv calibration files to Asset Management (AM), Endurance surface mooring protocol, Spring 2019 and earlier.

I create one master excel spreadsheet containing the serial numbers for all instruments for all Endurance moorings (excluding profilers) in a given turn by inspecting all the platforms (Buoy, Riser, MFN) as they are being assembled. I run a Matlab script which reads the information in the master sheet and creates a directory tree with a folder representing each surface mooring. These directories each contain platform (e.g. MFN) subfolders, with each platform subfolder containing subfolders named for each instrument with the serial number included. The directory tree is pasted underneath the appropriate deployment-date folder on a local server. The subfolders of the instruments requiring a csv calibration file are populated by hand with all relevant vendor calibration documentation and QCT results downloaded from Vault; for NUTNRs the calibration file generated by executing the pre-deployment calibration protocol is also included. A Matlab script is run which accesses an up-to-date copy of AM on a local computer and which writes out the name of every csv calibration file (which includes both serial number and calibration date) for every instrument in the deployment. The dates of the QCTs and the calibration dates of the vendor files in the instrument subfolders on the local server are compared against the latest calibration date on AM to help determine whether the most current calibration data reside in the instrument subfolders on the local server. For the instruments which require new calibration csv file entries in AM, the calibration coefficients (as listed in the vendor documentation, vendor calibration files, and loaded into the instrument firmware and archived into the QCTs) are checked for consistency; conflicts are resolved by contacting the vendor. Then, for each instrument class, a master Matlab export script is executed which calls the corresponding conversion script (one of the 'write_' main scripts) which creates the AM csv calibration files from the appropriate calibration coefficient source (which could be a calibration file, device file, QCT text …). The csv files are written to the instrument subfolder on the local server, to the appropriate calibration folder in the local copy of AM, and a scratch inspection folder. The files in the inspection folder are checked by eye against the vendor documentation for accuracy. Once the inspection is passed a pull request is submitted to merge the local copy of AM into the GitHub master repository. The folder tree on the local server is maintained as a permanent record. Each instrument subfolder contains the csv calibration file uploaded to AM and all of the relevant documentation used to generate it.

At a later date, just before the deployment cruise embarks, the serial numbers are checked against those listed in the moorings' config.xlsx files compiled by the workers who installed the instruments. Conflicts are resolved. Last checks are also made just before each mooring's deployment into the water in case instrumentation changes were made on board ship. If necessary supplementary pull requests are generated to update AM.

## Notes

Forerunners of these scripts were written to read in manufacturer calibration files and write calibration coefficients out to excel files so that they could be copy\pasted into the OOI program's "Omaha cal files" (which were excel files). When the transition was made to csv calibration files used by the current system many of the scripts were altered to write out text so as not to lose significant figures. It is possible that there is vestigial documentation within the current code left over from when Omaha calibration files were used in the program.

Later enhancements include using text files captured from QCTs as a source of calibration coefficients; one example is the DOSTA script. For this case the QCT filename must be modified by the user by appending the caldate found in the Aanderaa calibration certificate in OOI format (YYYYMMDD) to the QCT filename so that the script can parse it to create the csv calibration filename.

## Author

** ** Russell Desiderio, Oregon State University
